[Preface](#1-preface)

[Review process](#2-review-process)

[Architectural Recommendations](#3-architectural-recommendations)

[Call trace diagrams](#4-call-trace-diagrams)

[Weak spots and mitigations](#5-weak-spots-and-mitigations)

[Conclusion](#6-conclusion)

***

## **1. Preface**
This analysis report for PoolTogether has been approached with the following key points and goals in mind:

 - Devoid of redundant documentation the protocol is familiar with.
 - Engineered towards provision of valuable insights and edge case issues the protocol left unnoticed.
 - Simple to grasp call-trace diagrams for first-time users who stumble upon this report in the future.

 ## **2. Review process**
 
 **D1-2:**
 - Understanding of PoolTogether's concept
 - Mapping out security and attack areas relating to shares, assets, dust accumulation, yield & prize claims.
 - Keeping track of the outlined areas with notes on contracts in-scope

**D2-4:**
 - Brainstorm possible reachability of undesired states
 - Test the areas identified
 - Further review of contract-level mitigations

**D4-7:**
 - 
 - 


 ## **3. Architectural Recommendations**

 ### Testing suite:

 **Rich coverage** - The PoolTogether team has tried to ensure the codebase is rigoriously tested. There exists a plethora of unit tests, some stateless fuzz tests, invariant and integration tests within the test suite bringing the coverage up to an aggresive 90%. The team has tested the contracts in-scope with various functioning environments and integrations. This technique covers testing for expected inputs/outputs as well as fail-safe end results for those unexpected inputs. Such in-depth suite of unit & stateless fuzzing tests ensure a pretty good coverage for the core functions call traces. But as with any testing suite, even 100% doesn't mean all lines of code are covered and tested with every inputs or call-traces that can happen.

 ### What is unique within the PoolTogether v5 vaults?
 - Dust utilization: During deposits of assets into an ERC4626 vault, you'd typically expect to be impacted by rounding in the case your deposit amounts are not completely whole e.g 199 aUSDC, 99 aUSDC etc. PoolTogether has a dust implementation to use such dust amounts for the next deposit. This is facilitated 

 - Prize claims generated by earned yield: There's a unique feature added in the PoolTogether v5 ERC4626 vaults. Deposits occur in the `PrizeVault` contract, such deposits are deposited into a yield bearing strategy called `yieldVaults` e.g on Aave. These `yieldVaults` earn tokens that is then sent back to the `PrizeVault`. Which are then contributed to the `prizePools` to faciliate prize allocations to winners after a round is drawn.


 ### Comparison between PoolTogether and Spectra Vaults
 
| Feature  | PoolTogether  | Spectra  |
|---|---|---|
| Goal  | Permissionless yield bearing vaults building upon older version of PoolTogether vaults | A permissionless interest rate derivatives protocol on Ethereum |
| Draws  | Deposits are pooled together in the `PrizeVault` contracts. These deposits are then deposited into a yield vault for example on Aave. The yield earned from such strategies are pooled and some portion is awarded to prize winner. The prize claim is facilitated automatically to the winner  | No such feature exists within the Spectra protocol. It is important to understand Spectra and PoolTogether differ quite a lot but they have some similarities. For example, while you don't have any prize claims, you actually still deposit into an ERC4626 vault that can unwrap your yield with interest right away   |
| Rounding protection  | PoolTogether has implemented a dust strategy facilated by yielf buffers. When the `PrizeVault` contracts are deployed, the deployer is to fund it with some initial insignificant asset balance e.g 1 USDC to cover as much as 1 million USDC rounding errors hence acting as a buffer for fail-safe rounding that doesn't impact user deposits/withdrawals  | Technically, you don't have such protection within the Spectra ERC4626 vaults. Your deposits are not protected by buffers. Instead the Spectra team have tried their best to mitigate this by writing code that does as best as it can to round in favor of the user which means in some cases, rounding issues still worry user withdrawals  |
| Share mints  | Share mints are 1:1. If you deposit 10 USDC, you get 10 shares | Share mints are relative to your IBT token balance and can become more when you unwrap into a yield and principal token - TY and PT tokens respectively  |


## **4. Call trace diagrams**
Entry point:
![Entry](https://rexjoseph.github.io/images/entry-point-pooltogether.png)

Exit point:
![Entry](https://rexjoseph.github.io/images/exit-point-pooltogether.png)


## **5. Weak spots and mitigations**
- **Opt for full fee claims** With the current implementation of the `PrizeVault`, the yield fee recipient when they claim yield fees get minted the amount of `_shares` they specified. The current implementation has a flaw in the sense that since the total accrued yield internal accounting variable specifically the `_yieldFeeBalance` gets wiped/reset/completely deducted, if the claimant claims 50 aUSDC whereas the accrued yield is 5000 aUSDC, the contract will wipe the state of the `_yieldFeeBalance` being 5000 aUSDC and only mint shares equivalent to 50 aUSDC thereby resulting in a loss of 4950 aUSDC for the protocol. Two ways to mitigate this: 1. Consider removing the `_shares` to mint argument and mint the full amount instead in shares which automatically removes this flaw. 2. Consider deducting only the claimed `_shares` from internal accounting rather than a complete wipe of it.

- **Yield vaults with any share mint ratio above or below 1:1 will be incompatible** Any yield with a share to mint ratio other than 1:1 is incompatible with PoolTogether's PrizeVaults. Assuming there's a yield vault on Aave newly deployed requiring 10 USDC deposit for 1 share, since PoolTogether's share ratio is 1:1 e.g for a 1 USDC deposit, I get 1 share, when PoolTogether attempts to deposit my funds into the yieldVault, my share value will round down to .10% which is a loss of funds when I try to pull back my shares. The recommendation for this issue is to use the same setting as the yield vaults which can be achieved by querying the yield vaults directly for example during deposits, call the `yieldVault.previewDeposit()` function rather than the `previewDeposit` of the `PrizeVault` contract. This gives the user something to expect so they can already see via the interface that a deposit that doesn't round up whole to full shares will be rounded down hence leading to a loss during withdrawal.


## **6. Conclusion**
In conclusion, the PoolTogether's Prize vault v5 is a great concept in the sense they implemented a yield buffer feature to minimize rounding issues staple to almost all ERC4626 vaults. Their implementation differs a lot from Spectra's yield vaults in the sense that 1. Winners can claim prizes each draw. 2. The yield buffer feature for the dust strategy which mitigates rounding with the donated assets to the contract.

### Time spent:
210 hours